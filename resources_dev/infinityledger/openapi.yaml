openapi: 3.0.3
info:
  title: MEF API
  description: |
    API for the Multi-dimensional Embedding Framework (MEF) - Infinity Ledger
    
    This API provides access to:
    - Vector search and indexing
    - Spiral snapshot creation and management
    - Ledger block operations
    - TIC (Temporal Information Crystal) operations
    - Domain-specific operations
  version: 1.0.0
  contact:
    name: MEF Core Team
    url: https://github.com/LashSesh/infinityledger
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.infinityledger.io
    description: Production server

tags:
  - name: health
    description: Health and status endpoints
  - name: search
    description: Vector search operations
  - name: spiral
    description: Spiral snapshot operations
  - name: ledger
    description: Ledger block operations
  - name: tic
    description: Temporal Information Crystal operations
  - name: metrics
    description: Prometheus metrics

paths:
  /healthz:
    get:
      tags:
        - health
      summary: Health check
      description: Returns the health status of the API server
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  version:
                    type: string
                    example: 1.0.0
                  timestamp:
                    type: string
                    format: date-time

  /metrics:
    get:
      tags:
        - metrics
      summary: Prometheus metrics
      description: Returns metrics in Prometheus format
      operationId: getMetrics
      responses:
        '200':
          description: Metrics data
          content:
            text/plain:
              schema:
                type: string

  /search:
    post:
      tags:
        - search
      summary: Vector search
      description: Search for similar vectors in the index
      operationId: searchVectors
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /upsert:
    post:
      tags:
        - search
      summary: Upsert vectors
      description: Insert or update vectors in the index
      operationId: upsertVectors
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpsertRequest'
      responses:
        '200':
          description: Upsert successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpsertResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /spiral/snapshot:
    post:
      tags:
        - spiral
      summary: Create spiral snapshot
      description: Create a new spiral snapshot from data
      operationId: createSnapshot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSnapshotRequest'
      responses:
        '200':
          description: Snapshot created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /spiral/snapshot/{snapshot_id}:
    get:
      tags:
        - spiral
      summary: Get spiral snapshot
      description: Retrieve a spiral snapshot by ID
      operationId: getSnapshot
      parameters:
        - name: snapshot_id
          in: path
          required: true
          schema:
            type: string
          description: The snapshot ID
      responses:
        '200':
          description: Snapshot data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SnapshotResponse'
        '404':
          description: Snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /ledger/block:
    post:
      tags:
        - ledger
      summary: Append block
      description: Append a new block to the ledger
      operationId: appendBlock
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AppendBlockRequest'
      responses:
        '200':
          description: Block appended successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlockResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /ledger/verify/{block_index}:
    get:
      tags:
        - ledger
      summary: Verify chain integrity
      description: Verify the integrity of the ledger chain up to a specific block
      operationId: verifyChain
      parameters:
        - name: block_index
          in: path
          required: true
          schema:
            type: integer
          description: The block index to verify up to
      responses:
        '200':
          description: Verification result
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  block_index:
                    type: integer
        '404':
          description: Block not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /tic/create:
    post:
      tags:
        - tic
      summary: Create TIC
      description: Create a new Temporal Information Crystal
      operationId: createTIC
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTICRequest'
      responses:
        '200':
          description: TIC created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TICResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    SearchRequest:
      type: object
      required:
        - query_vector
      properties:
        query_vector:
          type: array
          items:
            type: number
            format: float
          description: The query vector
        top_k:
          type: integer
          default: 10
          description: Number of results to return
        filters:
          type: object
          description: Optional filters to apply
        ef_search:
          type: integer
          description: HNSW ef_search parameter

    SearchResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchResult'
        query_time_ms:
          type: number
          format: float

    SearchResult:
      type: object
      properties:
        id:
          type: string
        score:
          type: number
          format: float
        metadata:
          type: object

    UpsertRequest:
      type: object
      required:
        - vectors
      properties:
        vectors:
          type: array
          items:
            $ref: '#/components/schemas/VectorItem'

    VectorItem:
      type: object
      required:
        - id
        - vector
      properties:
        id:
          type: string
        vector:
          type: array
          items:
            type: number
            format: float
        metadata:
          type: object

    UpsertResponse:
      type: object
      properties:
        upserted_count:
          type: integer
        upsert_time_ms:
          type: number
          format: float

    CreateSnapshotRequest:
      type: object
      required:
        - data
        - seed
      properties:
        data:
          type: object
          description: The data to create a snapshot from
        seed:
          type: string
          description: The seed for deterministic snapshot creation
        phase:
          type: integer
          description: Optional phase parameter

    SnapshotResponse:
      type: object
      properties:
        snapshot_id:
          type: string
        coordinates:
          type: array
          items:
            type: number
            format: float
        phase:
          type: integer
        timestamp:
          type: string
          format: date-time

    AppendBlockRequest:
      type: object
      required:
        - tic
        - snapshot
      properties:
        tic:
          type: object
          description: TIC data for the block
        snapshot:
          type: object
          description: Snapshot data for the block

    BlockResponse:
      type: object
      properties:
        block_index:
          type: integer
        block_hash:
          type: string
        timestamp:
          type: string
          format: date-time

    CreateTICRequest:
      type: object
      required:
        - seed
        - window
      properties:
        seed:
          type: string
        window:
          type: array
          items:
            type: string
            format: date-time
        fixpoint:
          type: array
          items:
            type: number
            format: float

    TICResponse:
      type: object
      properties:
        tic_id:
          type: string
        seed:
          type: string
        fixpoint:
          type: array
          items:
            type: number
            format: float
        invariants:
          type: object
        sigma_bar:
          type: object
        window:
          type: array
          items:
            type: string
            format: date-time
        proof:
          type: object

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time
