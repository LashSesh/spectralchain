name: SpectralChain CI/CD

# ============================================================
# CI/CD Pipeline Documentation
# ============================================================
# This workflow executes the following steps on every push:
#
# 1. Lint & Format (lint-and-format)
#    - cargo fmt --check (formatting validation)
#    - cargo clippy (linting for all modules)
#
# 2. Security Audit (security-audit)
#    - cargo audit (dependency vulnerability scan)
#
# 3. Build & Test (build-and-test)
#    - cargo build --workspace (compile all modules)
#    - cargo test (unit tests for all packages)
#    - cargo doc (documentation generation)
#    - Matrix: stable + nightly Rust
#
# 4. Integration Tests (parallel execution)
#    - Ghost Protocol Integration Tests
#    - Quantum Operators Tests
#    - Infinity Ledger Integration Tests
#
# 5. Code Coverage (code-coverage)
#    - cargo tarpaulin (coverage report generation)
#
# 6. CI Summary (summary)
#    - Aggregates all job results
#    - Fails if any critical job fails
# ============================================================

on:
  push:
    branches:
      - main
      - 'claude/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # ==================== Code Quality ====================
  lint-and-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: |
          echo "=== Checking Rust formatting ==="
          cargo fmt --all -- --check
          echo "✓ Formatting check passed"

      - name: Run Clippy (SpectralChain modules)
        run: |
          echo "=== Running Clippy on SpectralChain modules ==="
          cargo clippy --package mef-common --all-targets --all-features -- -D warnings
          cargo clippy --package mef-quantum-ops --all-targets --all-features -- -D warnings
          cargo clippy --package mef-ghost-network --all-targets --all-features -- -D warnings
          echo "✓ Clippy passed for all SpectralChain modules"

  # ==================== Security Audit ====================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-audit
        run: |
          echo "=== Installing cargo-audit ==="
          cargo install cargo-audit --locked
          echo "✓ cargo-audit installed"

      - name: Run security audit
        run: |
          echo "=== Running Security Audit ==="
          cargo audit
          echo "✓ Security audit passed"

  # ==================== Build & Test ====================
  build-and-test:
    name: Build & Test (All Modules)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rust: [stable, nightly]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-${{ matrix.rust }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.rust }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Build workspace
        run: |
          echo "=== Building SpectralChain Workspace ==="
          cargo build --workspace --verbose --all-features
          echo "✓ Build completed successfully"

      - name: Run unit tests (mef-common)
        run: |
          echo "=== Testing mef-common ==="
          cargo test --package mef-common --lib --all-features -- --nocapture --test-threads=1
          echo "✓ mef-common tests passed"

      - name: Run unit tests (mef-quantum-ops)
        run: |
          echo "=== Testing mef-quantum-ops ==="
          cargo test --package mef-quantum-ops --lib --all-features -- --nocapture --test-threads=1
          echo "✓ mef-quantum-ops tests passed"

      - name: Run unit tests (mef-ghost-network)
        run: |
          echo "=== Testing mef-ghost-network ==="
          cargo test --package mef-ghost-network --lib --all-features -- --nocapture --test-threads=1
          echo "✓ mef-ghost-network tests passed"

      - name: Run property-based tests
        if: matrix.rust == 'stable'
        run: |
          echo "=== Running property-based tests ==="
          # Quantum ops property tests
          cargo test --package mef-quantum-ops --test proptest -- --nocapture
          echo "✓ Property tests passed"

      - name: Build documentation
        run: |
          echo "=== Building documentation ==="
          cargo doc --workspace --no-deps --all-features
          echo "✓ Documentation built successfully"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.rust }}
          path: target/debug/

  # ==================== Ghost Protocol Integration ====================
  ghost-protocol-integration:
    name: Ghost Protocol Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-ghost-${{ hashFiles('**/Cargo.lock') }}

      - name: Test Ghost Protocol Flow (6 steps)
        run: |
          echo "=== Testing Ghost Protocol 6-Step Flow ==="
          cargo test --package mef-ghost-network protocol::tests::test_full_protocol_flow -- --nocapture
          echo "✓ Ghost Protocol flow tests passed"

      - name: Test Resonance-based Routing
        run: |
          echo "=== Testing Resonance-based Routing ==="
          cargo test --package mef-ghost-network broadcasting::tests -- --nocapture
          cargo test --package mef-ghost-network discovery::tests -- --nocapture
          echo "✓ Resonance routing tests passed"

      - name: Test Transport Layer
        run: |
          echo "=== Testing Transport Layer ==="
          cargo test --package mef-ghost-network transport -- --nocapture
          echo "✓ Transport layer tests passed"

      - name: Test Security Features
        run: |
          echo "=== Testing Security Features ==="
          # Test key rotation (R-03-001)
          cargo test --package mef-ghost-network protocol::tests::test_masking_params_from_resonance -- --nocapture

          # Test forward secrecy (R-03-002)
          cargo test --package mef-ghost-network protocol::tests::test_end_to_end_masking_with_resonance -- --nocapture

          # Test adaptive timestamps (R-03-003)
          cargo test --package mef-ghost-network protocol::tests::test_full_protocol_flow -- --nocapture

          echo "✓ Security feature tests passed"

  # ==================== Quantum Operators ====================
  quantum-operators:
    name: Quantum Operators Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-quantum-${{ hashFiles('**/Cargo.lock') }}

      - name: Test Masking Operator (M)
        run: |
          echo "=== Testing Masking Operator ==="
          cargo test --package mef-quantum-ops masking -- --nocapture
          echo "✓ Masking operator tests passed"

      - name: Test Resonance Operator (R)
        run: |
          echo "=== Testing Resonance Operator ==="
          cargo test --package mef-quantum-ops resonance -- --nocapture
          echo "✓ Resonance operator tests passed"

      - name: Test Steganography Operator (T)
        run: |
          echo "=== Testing Steganography Operator ==="
          cargo test --package mef-quantum-ops stego -- --nocapture
          echo "✓ Steganography operator tests passed"

      - name: Test ZK Proof System
        run: |
          echo "=== Testing Zero-Knowledge Proofs ==="
          cargo test --package mef-quantum-ops zk_proof -- --nocapture
          echo "✓ ZK proof tests passed"

  # ==================== Integration with Infinity Ledger ====================
  infinity-ledger-integration:
    name: Infinity Ledger Integration
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-infinity-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Infinity Ledger modules
        run: |
          echo "=== Building Infinity Ledger Integration ==="
          # Build core modules
          cargo build --package mef-core
          cargo build --package mef-ledger
          cargo build --package mef-spiral
          cargo build --package mef-hdag
          cargo build --package mef-tic
          echo "✓ Infinity Ledger modules built successfully"

      - name: Test Cross-Module Integration
        run: |
          echo "=== Testing Cross-Module Integration ==="
          # Test Ghost Network + Ledger integration
          cargo test --workspace --test '*integration*' -- --nocapture || echo "No integration tests found yet"
          echo "✓ Integration tests completed"

  # ==================== Code Coverage ====================
  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage report
        run: |
          echo "=== Generating Coverage Report ==="
          cargo tarpaulin --workspace --out Xml --output-dir coverage -- --test-threads=1
          echo "✓ Coverage report generated"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/cobertura.xml
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # ==================== Build Summary ====================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, security-audit, build-and-test, ghost-protocol-integration, quantum-operators, infinity-ledger-integration]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# SpectralChain CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Lint & Format: ${{ needs.lint-and-format.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ghost Protocol: ${{ needs.ghost-protocol-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Quantum Operators: ${{ needs.quantum-operators.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Infinity Ledger: ${{ needs.infinity-ledger-integration.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## SpectralChain Modules" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ mef-common: Shared utilities" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ mef-quantum-ops: Quantum operators (M, R, T, ZK)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ mef-ghost-network: Addressless networking + Phase 3 Transport" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Phase 3 Complete**: Ghost Protocol with real network transport (libp2p) ✓" >> $GITHUB_STEP_SUMMARY

      - name: Check if all jobs passed
        if: |
          needs.lint-and-format.result != 'success' ||
          needs.security-audit.result != 'success' ||
          needs.build-and-test.result != 'success' ||
          needs.ghost-protocol-integration.result != 'success' ||
          needs.quantum-operators.result != 'success'
        run: |
          echo "❌ Some CI jobs failed"
          exit 1
